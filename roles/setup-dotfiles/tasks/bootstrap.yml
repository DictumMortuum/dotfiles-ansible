- name: install git
  pacman: name=git
  become_user: root
  tags:
    - packages

- name: install tcl
  pacman: name=tcl
  become_user: root
  tags:
    - packages

- name: initialize dotfiles for {{ home }}
  command: git --git-dir="{{ git_dir }}" init
  args:
    creates: "{{ git_dir }}"
    chdir: "{{ home }}"

- name: check if remote exists
  command: git --git-dir="{{ git_dir }}" --work-tree="{{ home }}" remote get-url domus
  register: dotfiles
  changed_when: dotfiles.stdout != thirdparty ~ "/dotfiles"
  failed_when: '"domus" not in dotfiles.stderr and dotfiles.stderr != ""'
  notify:
    - add the dotfiles remote url
    - fetch dotfiles
    - checkout master
    - set local master to track remote master branch

- meta: flush_handlers

- name: pull latest dotfiles
  command: git --git-dir="{{ git_dir }}" --work-tree="{{ home }}" pull domus master
  register: dotfiles
  changed_when: dotfiles.stdout != "Already up to date."
